<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StudentBackendServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">studentdetails</a> &gt; <a href="index.source.html" class="el_package">com.pip.studentdetails.backend.service</a> &gt; <span class="el_source">StudentBackendServiceImpl.java</span></div><h1>StudentBackendServiceImpl.java</h1><pre class="source lang-java linenums">package com.pip.studentdetails.backend.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.pip.studentdetails.backend.exception.StudentAlreadyExistsException;
import com.pip.studentdetails.backend.repository.StudentDetailsRepository;
import com.pip.studentdetails.backend.repository.StudentRepository;
import com.pip.studentdetails.backend.request.StudentDetailsRequest;
import com.pip.studentdetails.backend.request.StudentRequest;
import com.pip.studentdetails.backend.response.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.stream.Collectors;

/**
 * Service layer implementation for Student Backend operations.
 */
@Service(&quot;StudentBackendServiceImpl&quot;)
<span class="fc" id="L21">public class StudentBackendServiceImpl implements StudentBackendService {</span>

    /**
     * Repository for Student table operations and Used to insert a student record into the database.
     */
    @Autowired
    private StudentRepository studentRepository;

    /**
     * Repository for StudentDetails table operations and Used to insert student marks per subject.
     */
    @Autowired
    private StudentDetailsRepository studentDetailsRepository;

<span class="fc" id="L35">    ObjectMapper mapper = new ObjectMapper();</span>

    /**
     * Creates a Student record in the database.
     * studentRequest.studentId(), studentRequest.departmentId(), studentRequest.sectionId()
     */
    @Override
    public void createStudent(StudentRequest studentRequest) {

<span class="fc bfc" id="L44" title="All 2 branches covered.">        if (studentRepository.existsById(studentRequest.studentId())) {</span>
<span class="fc" id="L45">            throw new StudentAlreadyExistsException(</span>
<span class="fc" id="L46">                    &quot;Student with id &quot; + studentRequest.studentId() + &quot; already exists&quot;);</span>
        }
        // Passing record values to repository insert method
<span class="fc" id="L49">        studentRepository.insertStudent(studentRequest.studentId(),studentRequest.studentName(),studentRequest.departmentId(),studentRequest.sectionId());</span>
<span class="fc" id="L50">    }</span>

    /**
     * Creates StudentDetails record(s) in the database.
     */
    @Override
    public void createStudentDetails(StudentDetailsRequest studentDetailsRequest) {
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (studentRepository.existsById(studentDetailsRequest.studentId())) {</span>
<span class="nc" id="L58">            throw new StudentAlreadyExistsException(</span>
<span class="nc" id="L59">                    &quot;Student with id &quot; + studentDetailsRequest.studentId() + &quot; already exists&quot;);</span>
        }
        // Passing record values to repository insert method
<span class="fc" id="L62">        studentDetailsRepository.insertStudentDetails(studentDetailsRequest.studentId(), studentDetailsRequest.subjectId(), studentDetailsRequest.marks());</span>
<span class="fc" id="L63">    }</span>

    /**
     * Fetching the department topper list from database based on the departmentId
     * return the string object
     */
    @Override
    public String getDepartmentTopperDetails(String departmentId) {
        try {

        /**Fetch Raw Data from Database*/
<span class="fc" id="L74">        List&lt;DepartmentTopper&gt; departmentTopperDetails = studentRepository.fetchStudentMarksForTopper(departmentId)</span>
<span class="fc" id="L75">                .stream()</span>
<span class="fc" id="L76">                .map(r -&gt; new DepartmentTopper(</span>
<span class="fc" id="L77">                        r[0].toString(), r[1].toString(), r[2].toString(), r[3].toString(), ((Number) r[4]).intValue(), r[5].toString()</span>
<span class="fc" id="L78">                )).toList();</span>

<span class="fc" id="L80">        List&lt;DepartmentTopperRecord&gt; departmentTopperRecordList=departmentTopperDetails.stream()</span>
<span class="fc" id="L81">                .collect(Collectors.groupingBy(DepartmentTopper::semesterId))</span>
<span class="fc" id="L82">                .values().stream()</span>
<span class="fc" id="L83">                .flatMap(departmentTopperListBySemester -&gt;  {</span>
<span class="fc" id="L84">                    List&lt;DepartmentTopperRecord&gt; departmentTopperRecords =</span>
<span class="fc" id="L85">                            departmentTopperListBySemester.stream()</span>
<span class="fc" id="L86">                                    .collect(Collectors.groupingBy(DepartmentTopper::studentId))</span>
<span class="fc" id="L87">                                    .values().stream()</span>
<span class="fc" id="L88">                                    .map(departmentTopperList -&gt; {</span>
<span class="fc" id="L89">                                        DepartmentTopper departmentTopper = departmentTopperList.get(0);</span>
<span class="fc" id="L90">                                        int totalMarks = departmentTopperList.stream()</span>
<span class="fc" id="L91">                                                .mapToInt(DepartmentTopper::marks)</span>
<span class="fc" id="L92">                                                .sum();</span>
<span class="fc" id="L93">                                        int totalSubjects = departmentTopperList.size();</span>
<span class="fc" id="L94">                                        double percentage = Math.round((totalMarks/(totalSubjects*100.0))*10000)/100.0;</span>
<span class="fc" id="L95">                                        return new DepartmentTopperRecord(</span>
<span class="fc" id="L96">                                                departmentTopper.studentId(),</span>
<span class="fc" id="L97">                                                departmentTopper.studentName(),</span>
<span class="fc" id="L98">                                                percentage,</span>
<span class="fc" id="L99">                                                &quot;Semester &quot; +departmentTopper.semesterId().replaceAll(&quot;\\D+&quot;, &quot;&quot;),</span>
<span class="fc" id="L100">                                                departmentTopper.departmentName()</span>
                                        );
                                    })
<span class="fc" id="L103">                                    .sorted(Comparator.comparingDouble(DepartmentTopperRecord::percentage).reversed())</span>
<span class="fc" id="L104">                                .toList();</span>

<span class="fc" id="L106">                   double maxPercentage = departmentTopperRecords.stream()</span>
<span class="fc" id="L107">                        .mapToDouble(DepartmentTopperRecord::percentage)</span>
<span class="fc" id="L108">                        .max()</span>
<span class="fc" id="L109">                        .orElse(0);</span>
<span class="fc" id="L110">                return departmentTopperRecords.stream()</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">                        .filter(r -&gt; r.percentage() == maxPercentage);</span>
<span class="fc" id="L112">                }).sorted(Comparator.comparing(DepartmentTopperRecord::semesterId)).toList();</span>
<span class="fc" id="L113">            return mapper.writeValueAsString(departmentTopperRecordList);</span>
        }
<span class="nc" id="L115">        catch(JsonProcessingException e) {</span>
<span class="nc" id="L116">                throw new RuntimeException(&quot;Exception Occurred while processing&quot; + e);</span>
        }
    }

    /**
     * Fetching the department wise ranking list from database based on the departmentId
     * Who has &lt; 40 then should be fail and record should be null
     * return the string object
     */
    public String getDepartmentWiseRankingDetails(String departmentId){
        try {
            /** Fetch raw rows from DB and map to domain rows*/
<span class="fc" id="L128">            List&lt;StudentRanking&gt; subjectRowsByStudent  = studentRepository.fetchStudentMarksForRanking(departmentId)</span>
<span class="fc" id="L129">                    .stream().map(r -&gt; new StudentRanking(r[0].toString(), r[1].toString(), r[2].toString(), r[3].toString(), r[4].toString(), ((Number) r[5]).intValue(), r[6].toString())).toList();</span>

<span class="fc" id="L131">            List&lt;StudentRankingRecord&gt; rankedStudentsAcrossSemesters = subjectRowsByStudent .stream().collect(Collectors.groupingBy(StudentRanking::semesterId)).values().stream().flatMap(studentRankingRecordListBySemester -&gt; {</span>
<span class="fc" id="L132">                        List&lt;StudentRankingRecord&gt; listOfStudentRankingRecords = studentRankingRecordListBySemester.stream()</span>
<span class="fc" id="L133">                                .collect(Collectors.groupingBy(StudentRanking::studentId))</span>
<span class="fc" id="L134">                                .values().stream().map(studentRankingList -&gt; {</span>
<span class="fc" id="L135">                                    StudentRanking studentRanking = studentRankingList.get(0);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">                                    boolean isFailed=studentRankingList.stream().anyMatch(s -&gt; s.marks() &lt; 40);</span>
<span class="fc" id="L137">                                    int totalMarksForSemester  = studentRankingList.stream().mapToInt(StudentRanking::marks).sum();</span>
<span class="fc" id="L138">                                    int subjectsForThisStudentInSemester  = studentRankingList.size();</span>
<span class="fc" id="L139">                                    double percentage = Math.round((totalMarksForSemester / (subjectsForThisStudentInSemester * 100.0)) * 10000) / 100.0;</span>
<span class="fc" id="L140">                                    return new StudentRankingRecord(0, studentRanking.studentId(), studentRanking.studentName(), studentRanking.section(), percentage, &quot;Semester &quot; + studentRanking.semesterId().replaceAll(&quot;\\D+&quot;, &quot;&quot;), studentRanking.departmentName(), isFailed</span>
                                    );
<span class="fc" id="L142">                                }).sorted(Comparator.comparingDouble(StudentRankingRecord::percentage).reversed()).toList();</span>

<span class="fc" id="L144">                        int currentRank  = 0;</span>
<span class="fc" id="L145">                        double previousPercentage  = Double.NaN;</span>
<span class="fc" id="L146">                        List&lt;StudentRankingRecord&gt; rankedInThisSemester = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">                        for (StudentRankingRecord r : listOfStudentRankingRecords) {</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                            if (!r.isFailed()) {</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                                if (Double.compare(r.percentage(), previousPercentage ) != 0) { currentRank ++; previousPercentage = r.percentage();</span>
                                }
<span class="fc" id="L151">                                rankedInThisSemester.add(new StudentRankingRecord(currentRank, r.studentId(), r.studentName(), r.section(), r.percentage(), r.semesterId(), r.departmentName(), false));</span>
<span class="nc" id="L152">                            }else{ rankedInThisSemester.add(new StudentRankingRecord(0, r.studentId(), r.studentName(), r.section(), r.percentage(), r.semesterId(), r.departmentName(), true));}</span>
<span class="fc" id="L153">                        }</span>
<span class="fc" id="L154">                        return rankedInThisSemester.stream();</span>
<span class="fc" id="L155">                    }).sorted(Comparator.comparing(StudentRankingRecord::semesterId)).toList();</span>

<span class="fc" id="L157">            List&lt;Map&lt;String, Object&gt;&gt; noRankedStudents = rankedStudentsAcrossSemesters.stream().map(r -&gt; { Map&lt;String, Object&gt; m = new LinkedHashMap&lt;&gt;();</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">                        m.put(&quot;rank&quot;, r.rank() == 0 ? &quot;NA&quot; : String.valueOf(r.rank())); m.put(&quot;studentId&quot;, r.studentId()); m.put(&quot;studentName&quot;, r.studentName()); m.put(&quot;section&quot;, r.section()); m.put(&quot;percentage&quot;, r.percentage()); m.put(&quot;semesterId&quot;, r.semesterId()); m.put(&quot;departmentName&quot;, r.departmentName()); m.put(&quot;isFailed&quot;, r.isFailed());return m;</span>
<span class="fc" id="L159">                    }).toList();</span>
<span class="fc" id="L160">            return mapper.writeValueAsString(noRankedStudents);</span>
<span class="nc" id="L161">        }catch(JsonProcessingException e) {throw new RuntimeException(&quot;Exception Occurred while processing&quot; + e);</span>
        }
    }

    /**Fetch the details from student table for department-wise pass percentage*/
    public String getDepartmentWisePassPercentageDetails() {
        try {
<span class="fc" id="L168">            List&lt;DepartmentPassPercentageRecord&gt; departmentPassPercentageRecordList = studentRepository.fetchDetailsForPassPercentage()</span>
<span class="fc" id="L169">                    .stream().map(r -&gt; new DepartmentPassPercentageRecord(r[0].toString(), r[1].toString(), r[2].toString(), r[3].toString(), r[4].toString(), ((Number) r[5]).intValue()</span>
<span class="fc" id="L170">                    )).toList();</span>
<span class="fc" id="L171">            List&lt;PassPercentageReport&gt; passPercenatgeReportList = departmentPassPercentageRecordList</span>
<span class="fc" id="L172">                    .stream().collect(Collectors.groupingBy(departmentPassPercentageRecord -&gt;</span>
<span class="fc" id="L173">                            departmentPassPercentageRecord.departmentName() + &quot;|&quot; + departmentPassPercentageRecord.semesterId() + &quot;|&quot; + departmentPassPercentageRecord.subjectId() + &quot;|&quot; + departmentPassPercentageRecord.section()</span>
<span class="fc" id="L174">                    )).entrySet().stream().map(departmentWisePassPercentageDetails -&gt; {</span>
<span class="fc" id="L175">                        List&lt;DepartmentPassPercentageRecord&gt; departmentPassPercentageRecords = departmentWisePassPercentageDetails.getValue();</span>
<span class="fc" id="L176">                        int totalStudents = departmentPassPercentageRecords.size();</span>
<span class="fc" id="L177">                        int passedStudents = (int) departmentPassPercentageRecords.stream()</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">                                .filter(departmentPassPercentageRecord -&gt; departmentPassPercentageRecord.marks() &gt;= 40)</span>
<span class="fc" id="L179">                                .count();</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                        double percentage = totalStudents == 0 ? 0 : (passedStudents * 100.0) / totalStudents;</span>
<span class="fc" id="L181">                        percentage = Math.round(percentage * 100.0) / 100.0;</span>
<span class="fc" id="L182">                        DepartmentPassPercentageRecord first = departmentPassPercentageRecords.get(0);</span>
<span class="fc" id="L183">                        return new PassPercentageReport(first.departmentName(), &quot;Semester &quot; + first.semesterId().replaceAll(&quot;\\D+&quot;, &quot;&quot;), first.subjectId(), first.subjectName(), first.section(), percentage);</span>
                    })
<span class="fc" id="L185">                    .sorted(Comparator.comparing(PassPercentageReport::departmentName).thenComparing(PassPercentageReport::semesterId).thenComparing(PassPercentageReport::subjectId).thenComparing(PassPercentageReport::section)</span>
<span class="fc" id="L186">                    ).toList();</span>
<span class="fc" id="L187">            return mapper.writeValueAsString(passPercenatgeReportList);</span>
<span class="nc" id="L188">        } catch (JsonProcessingException e) {throw new RuntimeException(&quot;Exception Occurred while processing&quot; + e); }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>